!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("three")):"function"==typeof define&&define.amd?define("prettyGraphCore",["three"],t):"object"==typeof exports?exports.prettyGraphCore=t(require("three")):e.prettyGraphCore=t(e.three)}("undefined"!=typeof self?self:this,function(e){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(t,n){t.exports=e},function(e,t,n){"use strict";n.r(t);var i,r,s,o,a,h=n(0),d=function(){function e(){this.events={}}return e.prototype.on=function(e,t){var n=this;return"object"!=typeof this.events[e]&&(this.events[e]=[]),this.events[e].push(t),function(){return n.removeListener(e,t)}},e.prototype.removeListener=function(e,t){if("object"==typeof this.events[e]){var n=this.events[e].indexOf(t);n>-1&&this.events[e].splice(n,1)}},e.prototype.removeAllListeners=function(){var e=this;Object.keys(this.events).forEach(function(t){return e.events[t].splice(0,e.events[t].length)})},e.prototype.emit=function(e){for(var t=this,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];"object"==typeof this.events[e]&&this.events[e].slice().forEach(function(e){return e.apply(t,n)})},e.prototype.once=function(e,t){var n=this,i=this.on(e,function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];i(),t.apply(n,e)});return i},e}(),c=(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),l=function(e){function t(t){var n=e.call(this)||this;return n._graph=t,n}return c(t,e),t.prototype.hide=function(){this._arrowMesh.visible=!1},t.prototype.show=function(){this._arrowMesh.visible=!0},t.prototype.recalculate=function(){if(this._arrowGeometry){var e=this._calculateArrowData().vertices;this._arrowGeometry.boundingSphere=this._computeBoundingSphere(e),this._arrowGeometry.attributes.position.setArray(e),this._arrowGeometry.attributes.position.needsUpdate=!0}},t.prototype.draw=function(){this._arrowGeometry=new h.BufferGeometry;var e=this._calculateArrowData(),t=e.vertices,n=e.colors;this._arrowGeometry.addAttribute("position",new h.BufferAttribute(t,2).setDynamic(!0)),this._arrowGeometry.addAttribute("color",new h.Float32BufferAttribute(n,3).setDynamic(!0)),this._arrowGeometry.computeVertexNormals(),this._arrowGeometry.boundingSphere=this._computeBoundingSphere(t),this._arrowMaterial=new h.ShaderMaterial({depthTest:!1,fragmentShader:"\n  precision highp float;\n\n  varying vec3 vColor;\n\n  void main() {\n    gl_FragColor = vec4(vColor, 1.0);\n  }\n",side:h.BackSide,transparent:!1,vertexColors:h.VertexColors,vertexShader:"\n  precision mediump float;\n\n  attribute vec3 translation;\n\n  varying vec3 vColor;\n\n  void main() {\n    vColor = color;\n\n    vec3 pos = position + translation;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  }\n"}),this._arrowMaterial.name="ArrowMaterial",this._arrowMesh=new h.Mesh(this._arrowGeometry,this._arrowMaterial),this._graph._scene.add(this._arrowMesh)},t.prototype.dispose=function(){this._arrowMesh&&this._graph._scene.remove(this._arrowMesh),this._arrowMaterial&&this._arrowMaterial.dispose(),this._arrowGeometry&&this._arrowGeometry.dispose()},t.prototype._calculateArrowData=function(){for(var e=this._graph.edges,t=new Float32Array(6*e.length),n=new Float32Array(9*e.length),i=new h.Color,r=0,s=0,o=0,a=e.length;r<a;r++,s+=6,o+=9)if("none"!==e[r].arrow){var d=void 0,c=void 0;"target"===e[r].arrow?(d=e[r].source,c=e[r].target):(d=e[r].target,c=e[r].source),i.setHex(e[r].color);var l=this._calculateArrowVertices(e[r].size,d,c);t[s+0]=l.pointBelow[0]||0,t[s+1]=l.pointBelow[1]||0,t[s+2]=l.pointOnLine[0]||0,t[s+3]=l.pointOnLine[1]||0,t[s+4]=l.pointAbove[0]||0,t[s+5]=l.pointAbove[1]||0,n[o+0]=i.r,n[o+1]=i.g,n[o+2]=i.b,n[o+3]=i.r,n[o+4]=i.g,n[o+5]=i.b,n[o+6]=i.r,n[o+7]=i.g,n[o+8]=i.b}return{colors:n,vertices:t}},t.prototype._calculateArrowVertices=function(e,t,n){var i=n.size/2*this._graph.nodeScalingFactor-.4,r=t.x-n.x,s=t.y-n.y,o=Math.atan2(s,r),a=Math.sqrt(r*r+s*s),h=n.x+i*Math.cos(o),d=n.y+i*Math.sin(o),c=e<6?6:e,l=e<6?12:2*e,_=[h+l*r/a,d+l*s/a];return{pointAbove:[_[0]+c*-s/a,_[1]+c*r/a],pointBelow:[_[0]-c*-s/a,_[1]-c*r/a],pointOnLine:[h,d]}},t.prototype._computeBoundingSphere=function(e){var t=new h.Sphere;if(e){for(var n=new h.Vector2,i=new h.Vector2(t.center.x,t.center.y),r=0,s=0,o=e.length;s<o;s+=2)n.fromArray(e,s),r=Math.max(r,i.distanceToSquared(n));t.radius=Math.sqrt(r),isNaN(t.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}return t},t}(h.EventDispatcher);function _(e){h.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:h.UniformsUtils.clone(h.ShaderLib.line.uniforms),vertexShader:h.ShaderLib.line.vertexShader,fragmentShader:h.ShaderLib.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},useColor:{enumerable:!0,get:function(){return this.uniforms.useColor.value},set:function(e){this.uniforms.useColor.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},scale:{enumerable:!0,get:function(){return this.uniforms.scale.value},set:function(e){this.uniforms.scale.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}}),this.setValues(e)}function u(){h.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.addAttribute("position",new h.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.addAttribute("uv",new h.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}function p(e,t){h.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==e?e:new u,this.material=void 0!==t?t:new _({color:16777215*Math.random()})}function g(e,t){p.call(this),this.type="Line2",this.geometry=void 0!==e?e:new h.LineGeometry,this.material=void 0!==t?t:new h.LineMaterial({color:16777215*Math.random()})}h.UniformsLib.line={resolution:{value:new h.Vector2(1,1)},dashScale:{value:1},useColor:{value:0},dashSize:{value:1},scale:{value:1},gapSize:{value:1}},h.ShaderLib.line={uniforms:h.UniformsUtils.merge([h.UniformsLib.common,h.UniformsLib.fog,h.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n    uniform vec2 resolution;\n    uniform float scale;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n    attribute float linewidth;\n    attribute float dashed;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n    varying vec2 vUv;\n    varying float vDashed;\n\n    uniform float dashScale;\n    attribute float instanceDistanceStart;\n    attribute float instanceDistanceEnd;\n    varying float vLineDistance;\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\tif (dashed > 0.5) {\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n      }\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n      vUv = uv;\n      vDashed = dashed;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n      // adjust for linewidth\n      if (scale > 1.0)\n        offset *= linewidth * scale;\n      else\n        offset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float useColor;\n\n    uniform float dashSize;\n    uniform float gapSize;\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n    varying vec2 vUv;\n    varying float vDashed;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\tif (vDashed > 0.5) {\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n      }\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tif (useColor == 1.0) {\n\t\t\t\tgl_FragColor = vec4( vColor, 1.0 );\n\t\t\t} else {\n\t\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\t\t\t}\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"},_.prototype=Object.create(h.ShaderMaterial.prototype),_.prototype.constructor=_,_.prototype.isLineMaterial=!0,_.prototype.copy=function(e){return h.ShaderMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.resolution=e.resolution,this},u.prototype=Object.assign(Object.create(h.InstancedBufferGeometry.prototype),{constructor:u,isLineSegmentsGeometry:!0,applyMatrix:function(e){var t=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==t&&(e.applyToBufferAttribute(t),e.applyToBufferAttribute(n),t.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var n=new h.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceStart",new h.InterleavedBufferAttribute(n,3,0)),this.addAttribute("instanceEnd",new h.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var n=new h.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceColorStart",new h.InterleavedBufferAttribute(n,3,0)),this.addAttribute("instanceColorEnd",new h.InterleavedBufferAttribute(n,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new h.WireframeGeometry(e.geometry)),this},fromLineSegements:function(e){var t=e.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this},computeBoundingBox:(s=new h.Box3,function(){null===this.boundingBox&&(this.boundingBox=new h.Box3);var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),s.setFromBufferAttribute(t),this.boundingBox.union(s))}),computeBoundingSphere:(r=new h.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new h.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var i=0,s=0,o=e.count;s<o;s++)r.fromBufferAttribute(e,s),i=Math.max(i,n.distanceToSquared(r)),r.fromBufferAttribute(t,s),i=Math.max(i,n.distanceToSquared(r));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},clone:function(){},copy:function(e){return this}}),p.prototype=Object.assign(Object.create(h.Mesh.prototype),{constructor:p,isLineSegments2:!0,computeLineDistances:(o=new h.Vector3,a=new h.Vector3,function(){for(var e=this.geometry,t=e.attributes.instanceStart,n=e.attributes.instanceEnd,i=new Float32Array(2*t.data.count),r=0,s=0,d=t.data.count;r<d;r++,s+=2)o.fromBufferAttribute(t,r),a.fromBufferAttribute(n,r),i[s]=0===s?0:i[s-1],i[s+1]=i[s]+o.distanceTo(a);var c=new h.InstancedInterleavedBuffer(i,2,1);return e.addAttribute("instanceDistanceStart",new h.InterleavedBufferAttribute(c,1,0)),e.addAttribute("instanceDistanceEnd",new h.InterleavedBufferAttribute(c,1,1)),this}),copy:function(e){return this}}),g.prototype=Object.assign(Object.create(p.prototype),{constructor:g,isLine2:!0,copy:function(e){return this}});var f=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),v=function(){return(v=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},y=function(e){function t(t){var n=e.call(this)||this;return n._hoveredEdge=null,n._hoveredEdgeID=-1,n._graph=t,n._pickingTexture=new h.WebGLRenderTarget(n._graph._container.clientWidth,n._graph._container.clientHeight),n._pickingTexture.texture.minFilter=h.LinearFilter,n._pickingLineScene=new h.Scene,n._pickingLineScene.background=new h.Color(0),n}return f(t,e),Object.defineProperty(t.prototype,"hoveredEdge",{get:function(){return this._hoveredEdge},enumerable:!0,configurable:!0}),t.prototype.onResize=function(){this._lineMaterial&&(this._lineMaterial.resolution.set(this._graph._container.clientWidth,this._graph._container.clientHeight),this._lineMaterial.needsUpdate=!0),this._pickingTexture.setSize(this._graph._container.clientWidth,this._graph._container.clientHeight)},t.prototype.onScale=function(e){this._lineMaterial.uniforms.scale.value=e,this._lineMaterial.needsUpdate=!0},t.prototype.draw=function(){var e=this._constructLines(this._graph.edges);this._constructMesh(e),this._constructPickingMesh(e)},t.prototype._setEdgeColor=function(e){(new h.Color).setHex(e)},t.prototype.dispose=function(){this._lineMesh&&this._graph._scene.remove(this._lineMesh),this._linePickingMesh&&this._pickingLineScene.remove(this._linePickingMesh),this._lineMaterial&&this._lineMaterial.dispose(),this._lineGeometry&&this._lineGeometry.dispose(),this._linesPickingGeometry&&this._linesPickingGeometry.dispose(),this._pickingTexture&&this._pickingTexture.dispose()},t.prototype._setEdgeSize=function(e){if(this._hoveredEdge._lineSizeRange){var t=this._hoveredEdge._lineSizeRange[1]-this._hoveredEdge._lineSizeRange[0];if(t>1)for(var n=this._hoveredEdge._lineSizeRange[0];n<this._hoveredEdge._lineSizeRange[1]/2+2;n++)this._lineGeometry.attributes.linewidth.setX(n,e);else this._lineGeometry.attributes.linewidth.setX(this._hoveredEdge._lineSizeRange[0],e);if(this._lineGeometry.attributes.linewidth.updateRange={offset:this._hoveredEdge._lineSizeRange[0],count:t},this._lineGeometry.attributes.linewidth.needsUpdate=!0,t>1)for(n=this._hoveredEdge._lineSizeRange[0];n<this._hoveredEdge._lineSizeRange[1]/2+2;n++)this._linesPickingGeometry.attributes.linewidth.setX(n,e);else this._linesPickingGeometry.attributes.linewidth.setX(this._hoveredEdge._lineSizeRange[0],e);this._linesPickingGeometry.attributes.linewidth.updateRange={offset:this._hoveredEdge._lineSizeRange[0],count:t},this._linesPickingGeometry.attributes.linewidth.needsUpdate=!0}},t.prototype.testEdge=function(e){if(this._pickingTexture){this._graph._renderer.render(this._pickingLineScene,this._graph._camera,this._pickingTexture);var t=new Uint8Array(4);this._graph._renderer.readRenderTargetPixels(this._pickingTexture,e.x,this._pickingTexture.height-e.y,1,1,t);var n=t[0]<<16|t[1]<<8|t[2];n?this._hoveredEdgeID!==n-1&&(null!==this._hoveredEdge&&(this._setEdgeColor(this._hoveredEdge.color),this._setEdgeSize(this._hoveredEdge.size)),this._hoveredEdge=this._graph.edges[n-1],this._hoveredEdgeID=n-1,this._setEdgeColor(16711680),this._setEdgeSize(this._hoveredEdge.size<3?3:this._hoveredEdge.size),this._graph.onEvent.emit("edgeHover",v({edge:this._hoveredEdge},e))):null!==this._hoveredEdge&&(this._setEdgeColor(this._hoveredEdge.color),this._setEdgeSize(this._hoveredEdge.size),this._graph.onEvent.emit("edgeUnhover",{edge:this._hoveredEdge}),this._hoveredEdge=null,this._hoveredEdgeID=-1)}},t.prototype.recalculate=function(){var e=this._constructLines(this._graph.edges);this._lineGeometry.setPositions(e.positions)},t.prototype.recalculatePicking=function(){var e=this._constructLines(this._graph.edges);this._linesPickingGeometry.setPositions(e.positions)},t.prototype._constructMesh=function(e){this._lineGeometry=new u,this._lineGeometry.setPositions(e.positions),this._lineGeometry.setColors(e.colors);var t=new h.InstancedBufferAttribute(new Float32Array(e.sizes),1);t.setDynamic(!0);var n=new h.InstancedBufferAttribute(new Float32Array(e.isDashed),1);n.setDynamic(!0),this._lineGeometry.addAttribute("linewidth",t),this._lineGeometry.addAttribute("dashed",n),this._lineGeometry.attributes.instanceStart.data.dynamic=!0,this._lineGeometry.attributes.instanceEnd.data.dynamic=!0,this._lineMaterial=new _({dashScale:.1,dashSize:2,depthTest:!1,gapSize:1,scale:this._graph._controls?this._graph._controls.scale:1,vertexColors:h.VertexColors}),this._lineMaterial.useColor=1,this._lineMaterial.resolution.set(this._graph._container.clientWidth,this._graph._container.clientHeight),this._lineMesh=new g(this._lineGeometry,this._lineMaterial),this._lineMesh.computeLineDistances(),this._graph._scene.add(this._lineMesh)},t.prototype._constructPickingMesh=function(e){this._linesPickingGeometry=new u,this._linesPickingGeometry.setPositions(e.positions),this._linesPickingGeometry.setColors(e.pickingColors);var t=new h.InstancedBufferAttribute(new Float32Array(e.sizes),1);t.setDynamic(!0);var n=new h.InstancedBufferAttribute(new Float32Array(e.isDashed),1);n.setDynamic(!0),this._linesPickingGeometry.addAttribute("linewidth",t),this._linesPickingGeometry.addAttribute("dashed",n),this._linesPickingGeometry.attributes.instanceStart.data.dynamic=!0,this._linesPickingGeometry.attributes.instanceEnd.data.dynamic=!0,this._linePickingMaterial=new _({dashScale:.1,dashSize:2,depthTest:!1,gapSize:1,scale:this._graph._controls?this._graph._controls.scale:1,vertexColors:h.VertexColors}),this._linePickingMaterial.useColor=1,this._linePickingMaterial.resolution.set(this._graph._container.clientWidth,this._graph._container.clientHeight),this._linePickingMesh=new g(this._linesPickingGeometry,this._linePickingMaterial),this._linePickingMesh.computeLineDistances(),this._pickingLineScene.add(this._linePickingMesh),this._pickingLineScene.updateMatrixWorld(!0)},t.prototype._constructLines=function(e){var t=this,n=[],i=[],r=[],s=[],o=[],a=new h.Color,d=new h.Color;return e.forEach(function(e,c){var l,_,u=Math.atan2(e.target.y-e.source.y,e.target.x-e.source.x),p=e.source.x+e.source.size/2*t._graph.nodeScalingFactor*Math.cos(u),g=e.source.y+e.source.size/2*t._graph.nodeScalingFactor*Math.sin(u);if("none"===e.arrow?(l=e.target.x-e.target.size/2*t._graph.nodeScalingFactor*Math.cos(u),_=e.target.y-e.target.size/2*t._graph.nodeScalingFactor*Math.sin(u)):(l=e.target.x-(e.target.size/2*t._graph.nodeScalingFactor+2*e.size)*Math.cos(u),_=e.target.y-(e.target.size/2*t._graph.nodeScalingFactor+2*e.size)*Math.sin(u)),a.setHex(e.color),d.setHex(c+1),e.source.x===e.target.x&&e.source.y===e.target.y){var f=new h.Vector3(e.source.x,e.source.y||0,0),v=new h.Vector3(e.target.x,e.target.y||0,0),y=15*e.source.size,m=Math.PI/2-0,x=new h.CubicBezierCurve3(f,new h.Vector3(y*Math.cos(m),y*Math.sin(m),0).add(f),new h.Vector3(y*Math.cos(-0),y*Math.sin(-0),0).add(f),v).getPoints(50);e._lineSizeRange=[r.length,r.length+2*x.length];for(var b=void 0,w=0;w<x.length-1;w+=2)b?(n.push(b.x,b.y,0,x[w].x,x[w].y,0,x[w].x,x[w].y,0,x[w+1].x,x[w+1].y,0),r.push(e.size,e.size),"dashed"===e.type?s.push(1,1):s.push(0,0),i.push(a.r,a.g,a.b,a.r,a.g,a.b,a.r,a.g,a.b,a.r,a.g,a.b),o.push(d.r,d.g,d.b,d.r,d.g,d.b,d.r,d.g,d.b,d.r,d.g,d.b)):(n.push(x[w].x,x[w].y,0,x[w+1].x,x[w+1].y,0),r.push(e.size),"dashed"===e.type?s.push(1):s.push(0),i.push(a.r,a.g,a.b,a.r,a.g,a.b),o.push(d.r,d.g,d.b,d.r,d.g,d.b)),b=x[w+1]}else n.push(p,g,0,l,_,0),e._lineSizeRange=[r.length,r.length+1],r.push(e.size),"dashed"===e.type?s.push(1):s.push(0),i.push(a.r,a.g,a.b,a.r,a.g,a.b),o.push(d.r,d.g,d.b,d.r,d.g,d.b)}),{colors:i,isDashed:s,pickingColors:o,positions:n,sizes:r}},t}(h.EventDispatcher),m=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),x=function(e){function t(){var t=e.call(this)||this;return t.textureWidth=0,t.textureHeight=0,t.canvasHeight=4096,t.canvasWidth=4096,t._textOptionsToIndex={},t._textureIndex=0,t.canvas=document.createElement("canvas"),t.canvas.width=t.canvasWidth,t.canvas.height=t.canvasHeight,t.textureWidth=t.canvasWidth/8,t.textureHeight=30,t._ctx=t.canvas.getContext("2d"),t._ctx&&(t._ctx.fillStyle="white",t._ctx.clearRect(0,0,t.canvas.width,t.canvas.height)),t.textureMap=new h.CanvasTexture(t.canvas),t.textureMap.flipY=!1,t}return m(t,e),t.prototype.dispose=function(){this.textureMap.dispose()},t.prototype.drawText=function(e,t){var n=e;if(void 0!==this._textOptionsToIndex[n])return this._textOptionsToIndex[n];if(this._ctx){var i=this._textureIndex;this._textureIndex+=1,this._textOptionsToIndex[n]=i;var r=18/this.textureWidth,s=Math.round(r*this.textureWidth),o=i*this.textureWidth%this.canvasWidth,a=Math.floor(i*this.textureWidth/this.canvasWidth)*this.textureHeight;return this._ctx.beginPath(),this._ctx.fillStyle="white",this._ctx.clearRect(o,a,this.textureWidth,this.textureHeight),this._ctx.beginPath(),this._ctx.fillStyle=t.color,this._ctx.font=s+"px "+t.font,this._ctx.textAlign="start",this._ctx.textBaseline="middle",this._ctx.fillText(e,o+5,a+.5*this.textureHeight),this.textureMap.needsUpdate=!0,i}return-1},t}(h.EventDispatcher),b=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),w=function(e){function t(t,n){var i=e.call(this)||this;return i._labels=[],i._nodeScalingFactor=1,i._scene=t,i._nodeScalingFactor=n,i._textCanvas=new x,i}return b(t,e),t.prototype.addLabel=function(e,t,n,i){var r=this._labels.length;return this._labels.push({nodeSize:i,text:e,x:t,y:n}),r},t.prototype.show=function(){this._labelsMesh.visible=!0},t.prototype.hide=function(){this._labelsMesh.visible=!1},t.prototype.setLabelPosition=function(e,t,n){void 0===n&&(n=!0),this._labels[e].x=t.x,this._labels[e].y=t.y,n&&(this._labelsInstancedGeometry.attributes.translation.setXYZ(e,t.x+this._textCanvas.textureWidth/2,t.y,0),this._labelsInstancedGeometry.attributes.translation.needsUpdate=!0)},t.prototype.draw=function(){for(var e=new Float32Array(3*this._labels.length),t=new Float32Array(this._labels.length),n=new Float32Array(this._labels.length),i=0,r=0,s=this._labels.length;i<s;i++,r+=3){e[r+0]=this._labels[i].x+this._textCanvas.textureWidth/2,e[r+1]=this._labels[i].y,e[r+2]=0,n[i]=this._labels[i].nodeSize;var o=this._textCanvas.drawText(this._labels[i].text,{color:"black",font:"Arial"});this._labels[i]._labelIndex=o,t[i]=o}this._labelsBufferGeometry=new h.PlaneBufferGeometry(this._textCanvas.textureWidth,this._textCanvas.textureHeight),this._labelsInstancedGeometry=new h.InstancedBufferGeometry,this._labelsInstancedGeometry.index=this._labelsBufferGeometry.index,this._labelsInstancedGeometry.attributes=this._labelsBufferGeometry.attributes,this._labelsTranslateAttribute=new h.InstancedBufferAttribute(e,3),this._labelsInstancedGeometry.addAttribute("translation",this._labelsTranslateAttribute),this._labelsInstancedGeometry.addAttribute("size",new h.InstancedBufferAttribute(n,1)),this._labelsInstancedGeometry.addAttribute("image",new h.InstancedBufferAttribute(t,1)),this._labelsMaterial=new h.RawShaderMaterial({depthTest:!1,fragmentShader:"\n  precision highp float;\n\n  uniform sampler2D textureMap;\n\n  varying highp vec4 v_sprite;\n  varying vec2 vUv;\n\n  void main() {\n    vec2 uv = vec2( vUv.x, 1.0 - vUv.y );\n    gl_FragColor = texture2D(textureMap, vec2((v_sprite.s + v_sprite.p * uv.x), (v_sprite.t + v_sprite.q * uv.y)));\n  }\n",transparent:!0,uniforms:{nodeScalingFactor:{type:"f",value:this._nodeScalingFactor},spriteDim:{value:new h.Vector2(this._textCanvas.textureWidth,this._textCanvas.textureHeight)},textureDim:{value:new h.Vector2(this._textCanvas.canvasWidth,this._textCanvas.canvasHeight)},textureMap:{type:"t",value:this._textCanvas.textureMap}},vertexShader:"\n  precision mediump float;\n\n  uniform mat4 modelViewMatrix;\n  uniform mat4 projectionMatrix;\n  uniform vec2 spriteDim;\n  uniform vec2 textureDim;\n  uniform float nodeScalingFactor;\n\n  attribute vec3 position;\n  attribute vec3 translation;\n  attribute float image;\n  attribute float size;\n  attribute vec2 uv;\n\n  varying highp vec4 v_sprite;\n  varying vec2 vUv;\n\n  void main() {\n    vUv = uv;\n\n    highp vec2 sp = vec2(mod((image * spriteDim.x), textureDim.x), floor((image * spriteDim.x) / textureDim.y) * spriteDim.y);\n    v_sprite = vec4(sp.x / textureDim.x, sp.y / textureDim.y, spriteDim.x / textureDim.x, spriteDim.y / textureDim.y);\n\n    vec3 pos = position + translation;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos.x + nodeScalingFactor * (size / 2.0), pos.y, pos.z, 1.0);\n  }\n"}),this._labelsMesh=new h.Mesh(this._labelsInstancedGeometry,this._labelsMaterial),this._labelsMesh.frustumCulled=!1,this._labelsMesh.name="Labels",this._scene.add(this._labelsMesh)},t.prototype.recalculate=function(){for(var e=new Float32Array(3*this._labels.length),t=0,n=0,i=this._labels.length;t<i;t++,n+=3)e[n+0]=this._labels[t].x+this._textCanvas.textureWidth/2,e[n+1]=this._labels[t].y,e[n+2]=0;this._labelsInstancedGeometry.attributes.translation.setArray(e),this._labelsInstancedGeometry.attributes.translation.needsUpdate=!0},t.prototype.dispose=function(){this._labelsMesh&&this._scene.remove(this._labelsMesh),this._labelsMaterial&&this._labelsMaterial.dispose(),this._labelsInstancedGeometry&&this._labelsInstancedGeometry.dispose(),this._labelsBufferGeometry&&this._labelsBufferGeometry.dispose(),this._textCanvas&&this._textCanvas.dispose()},t}(h.EventDispatcher),S=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),L=function(e){function t(){var t=e.call(this)||this;return t.textureWidth=0,t.textureHeight=0,t.canvasHeight=4096,t.canvasWidth=4096,t._nodeImageToIndex={},t._textureIndex=0,t._enabled=!0,t.canvas=document.createElement("canvas"),t.canvas.width=t.canvasWidth,t.canvas.height=t.canvasHeight,t.textureWidth=t.canvasWidth/32,t.textureHeight=t.canvasHeight/32,t._ctx=t.canvas.getContext("2d"),t._ctx&&(t._ctx.fillStyle="white",t._ctx.fillRect(0,0,t.canvas.width,t.canvas.height)),t.textureMap=new h.CanvasTexture(t.canvas),t.textureMap.flipY=!1,t}return S(t,e),t.prototype.disable=function(){this._enabled=!1},t.prototype.enable=function(){this._enabled=!0},t.prototype.dispose=function(){this.textureMap.dispose()},t.prototype.loadImage=function(e){var t=this;if(void 0!==this._nodeImageToIndex[e])return this._nodeImageToIndex[e];if(this._ctx){var n=this._textureIndex;this._textureIndex+=1,this._nodeImageToIndex[e]=n;var i=new Image;return i.onload=function(){var e=n*t.textureWidth%t.canvasWidth,r=Math.floor(n*t.textureWidth/t.canvasWidth)*t.textureHeight;t._ctx&&t._ctx.drawImage(i,0,0,i.width,i.height,e+10,r+10,t.textureWidth-20,t.textureHeight-20),t.textureMap.needsUpdate=!0,t._enabled&&t.dispatchEvent({index:n,type:"imageLoaded"})},i.src=e,n}return-1},t}(h.EventDispatcher),M=function(){return(M=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};var C=function(){function e(e){var t,n,i,r=this;this.hoveredNode=null,this._colorToNodeID={},this._silent=!1,this._graph=e,this._imageLoaded=(t=function(){r._silent||r._graph._render()},n=800,i=!1,function(){i||(t.call(),i=!0,setTimeout(function(){i=!1},n))}),this._imageCanvas=new L,this._imageCanvas.addEventListener("imageLoaded",this._imageLoaded),this._pickingTexture=new h.WebGLRenderTarget(this._graph._container.clientWidth,this._graph._container.clientHeight),this._pickingTexture.texture.minFilter=h.LinearFilter,this._pickingNodesScene=new h.Scene,this._pickingNodesScene.background=new h.Color(0),this._color=new h.Color}return e.prototype.setSilent=function(e){this._silent=e},e.prototype.draw=function(){for(var e=new Float32Array(3*this._graph._nodes.length),t=new Float32Array(3*this._graph._nodes.length),n=new Float32Array(this._graph._nodes.length),i=new Float32Array(this._graph._nodes.length),r=0,s=0,o=this._graph._nodes.length;r<o;r++,s+=3){if(e[s+0]=this._graph._nodes[r].x,e[s+1]=this._graph._nodes[r].y,e[s+2]=0,this._color.setHex(this._graph._nodes[r].color),t[s+0]=this._color.r,t[s+1]=this._color.g,t[s+2]=this._color.b,n[r]=this._graph._nodes[r].size,this._graph._nodes[r].img){var a=this._imageCanvas.loadImage(this._graph._nodes[r].img);this._graph._nodes[r]._imageIndex=a,i[r]=a}else i[r]=-1;this._graph._nodes[r].__positionIndex=r,this._graph._labelsLayer&&this._graph._nodes[r].label&&(this._graph._nodes[r].__labelIndex=this._graph._labelsLayer.addLabel(this._graph._nodes[r].label,this._graph._nodes[r].x,this._graph._nodes[r].y,this._graph._nodes[r].size))}this._nodesBufferGeometry=new h.BufferGeometry,this._nodesInstancedGeometry=new h.InstancedBufferGeometry,this._nodesInstancedGeometry.index=this._nodesBufferGeometry.index,this._nodesInstancedGeometry.attributes=this._nodesBufferGeometry.attributes,this._nodesInstancedGeometry.addAttribute("position",new h.BufferAttribute(new Float32Array([0,0,0]),3)),this._nodeTranslateAttribute=new h.InstancedBufferAttribute(e,3),this._nodeTranslateAttribute.setDynamic(!0),this._nodeColorAttribute=new h.InstancedBufferAttribute(t,3),this._nodeColorAttribute.setDynamic(!0),this._nodesInstancedGeometry.addAttribute("translation",this._nodeTranslateAttribute),this._nodesInstancedGeometry.addAttribute("color",this._nodeColorAttribute),this._nodesInstancedGeometry.addAttribute("size",new h.InstancedBufferAttribute(n,1)),this._nodesInstancedGeometry.addAttribute("image",new h.InstancedBufferAttribute(i,1)),this._nodesMaterial=new h.RawShaderMaterial({depthTest:!1,depthWrite:!1,fragmentShader:"\n  #ifdef GL_OES_standard_derivatives\n  #extension GL_OES_standard_derivatives : enable\n  #endif\n\n  precision highp float;\n\n  uniform sampler2D textureMap;\n\n  varying float vScale;\n  varying float vNodeScaleFactor;\n  varying float vSize;\n  varying vec3 vColor;\n  varying float vImage;\n  varying highp vec4 v_sprite;\n\n  void main() {\n    vec2 uv = vec2( gl_PointCoord.x, gl_PointCoord.y );\n    float radius = 0.5;\n    float border = 0.0;\n    float distance = 0.0;\n\n    vec2 m = uv - vec2(0.5, 0.5);\n    float dist = radius - sqrt(dot(m, m));\n\n    if (vSize * vNodeScaleFactor * vScale > 30.0) {\n      distance = 0.025;\n      if (0.08 - vSize * (vScale / 1000.0) > 0.04) {\n        border = 0.08 - vSize * (vScale / 1000.0) / 2.0;\n      } else {\n        border = 0.06;\n      }\n\n      float sm = smoothstep(0.0, distance, dist);\n      float sm2 = smoothstep(border, border - distance, dist);\n      float alpha = sm*sm2;\n\n      float tm = smoothstep(border, border + distance, dist);\n\n      if (dist > border)\n        if (vImage > -1.0) {\n          gl_FragColor = vec4(texture2D(textureMap, vec2((v_sprite.s + v_sprite.p * uv.x), (v_sprite.t + v_sprite.q * uv.y))).rgb, tm);\n        } else {\n          gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n        }\n      else if (dist > 0.0)\n        gl_FragColor = vec4(vColor, alpha);\n      else discard;\n    } else if (vSize * vNodeScaleFactor * vScale > 12.0) {\n      distance = 0.1;\n      border = 0.15;\n      float l = vColor.r * 0.3 + vColor.g * 0.59 + vColor.b * 0.11;\n      if (l > 0.5) {\n        // gray\n        if (vScale < 0.5) {\n          distance = 0.1;\n          border = 0.25;\n        } else if (vScale > 10.0) {\n          border = 0.05;\n          distance = 0.016;\n        } else {\n          border = 0.2 - vScale / 50.0;\n          distance = border / 2.5;\n        }\n      }\n\n      float sm = smoothstep(0.0, distance, dist);\n      float sm2 = smoothstep(border, border - distance, dist);\n      float alpha = sm*sm2;\n\n      if (dist > border + 0.02) {\n        float r = 0.0, delta = 0.0, alpha2 = 1.0;\n        vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n        r = dot(cxy, cxy);\n        #ifdef GL_OES_standard_derivatives\n          delta = fwidth(r);\n          alpha2 = 1.0 - smoothstep(0.2 - delta, 0.2 + delta, r);\n        #endif\n\n        gl_FragColor = vec4(vColor, alpha2);\n      } else if (dist > 0.0) {\n        gl_FragColor = vec4(vColor, alpha);\n      } else discard;\n    } else {\n      float r = 0.0, delta = 0.0, alpha = 1.0;\n      vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n      r = dot(cxy, cxy);\n      #ifdef GL_OES_standard_derivatives\n        delta = fwidth(r);\n        alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\n      #endif\n\n      if (dist > 0.0)\n        gl_FragColor = vec4(vColor, alpha);\n      else discard;\n    }\n  }\n",transparent:!1,uniforms:{nodeScalingFactor:{type:"f",value:this._graph.nodeScalingFactor},scale:{type:"f",value:this._graph._controls?this._graph._controls.scale:1},spriteDim:{value:new h.Vector2(this._imageCanvas.textureWidth,this._imageCanvas.textureHeight)},textureDim:{value:new h.Vector2(this._imageCanvas.canvasWidth,this._imageCanvas.canvasHeight)},textureMap:{type:"t",value:this._imageCanvas.textureMap}},vertexColors:h.VertexColors,vertexShader:"\n  precision mediump float;\n\n  uniform mat4 modelViewMatrix;\n  uniform mat4 projectionMatrix;\n  uniform float scale;\n  uniform float nodeScalingFactor;\n  uniform vec2 spriteDim;\n  uniform vec2 textureDim;\n\n  attribute vec3 position;\n  attribute vec3 color;\n  attribute vec3 translation;\n  attribute float size;\n  attribute float image;\n\n  varying vec3 vColor;\n  varying float vScale;\n  varying float vNodeScaleFactor;\n  varying float vSize;\n  varying float vImage;\n  varying highp vec4 v_sprite;\n\n  void main() {\n    vColor = color;\n    vScale = scale;\n    vSize = size;\n    vImage = image;\n    vNodeScaleFactor = nodeScalingFactor;\n\n    highp vec2 sp = vec2(mod((image * spriteDim.x), textureDim.x), floor((image * spriteDim.x) / textureDim.y) * spriteDim.y);\n    v_sprite = vec4(sp.x / textureDim.x, sp.y / textureDim.y, spriteDim.x / textureDim.x, spriteDim.y / textureDim.y);\n\n    vec3 pos = position + translation;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n\n    if (size * scale * nodeScalingFactor > 5.0) {\n      gl_PointSize = size * scale * nodeScalingFactor;\n    } else {\n      gl_PointSize = 5.0;\n    }\n  }\n"}),this._nodeMesh=new h.Points(this._nodesInstancedGeometry,this._nodesMaterial),this._nodeMesh.frustumCulled=!1,this._nodeMesh.renderOrder=10,this._graph._scene.add(this._nodeMesh);var d=new Float32Array(3*this._graph._nodes.length);for(r=0,s=0,o=this._graph._nodes.length;r<o;r++,s+=3)this._color.setHex(r+1),d[s+0]=this._color.r,d[s+1]=this._color.g,d[s+2]=this._color.b,this._colorToNodeID[r+1]=this._graph._nodes[r].id;this._nodesPickingMaterial=new h.RawShaderMaterial({fragmentShader:"\n  #ifdef GL_OES_standard_derivatives\n  #extension GL_OES_standard_derivatives : enable\n  #endif\n\n  precision highp float;\n\n  varying vec3 vColor;\n\n  void main() {\n    float r = 0.0, delta = 0.0, alpha = 1.0;\n    vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n    r = dot(cxy, cxy);\n    if (r > 1.0) {\n      discard;\n    }\n\n    gl_FragColor = vec4(vColor, 1.0) * alpha;\n  }\n",uniforms:{nodeScalingFactor:{type:"f",value:this._graph.nodeScalingFactor},scale:{type:"f",value:this._graph._controls?this._graph._controls.scale:1}},vertexShader:"\n  precision mediump float;\n\n  uniform mat4 modelViewMatrix;\n  uniform mat4 projectionMatrix;\n  uniform float nodeScalingFactor;\n  uniform float scale;\n\n  attribute vec3 position;    // blueprint's vertex positions\n  attribute vec3 color;       // only used for raycasting\n  attribute vec3 translation; // x y translation offsets for an instance\n  attribute float size;\n\n  varying vec3 vColor;\n\n  void main() {\n    vColor = color;\n\n    vec3 pos = position + translation;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n\n    gl_PointSize = size * scale * nodeScalingFactor;\n  }\n"});var c=this._nodeMesh.clone();this._nodesPickingGeometry=c.geometry.clone(),this._nodesPickingGeometry.addAttribute("color",new h.InstancedBufferAttribute(d,3)),this._nodesPickingsMesh=new h.Points(this._nodesPickingGeometry,this._nodesPickingMaterial),this._nodesPickingsMesh.frustumCulled=!1,this._pickingNodesScene.add(this._nodesPickingsMesh),this._pickingNodesScene.updateMatrixWorld(!0)},e.prototype.setNodeColor=function(e){var t=new h.Color;t.setHex(e),null!==this.hoveredNode&&(this._nodeColorAttribute.setXYZ(this.hoveredNode.__positionIndex,t.r,t.g,t.b),this._nodeColorAttribute.needsUpdate=!0,this._graph._render())},e.prototype.setNodePosition=function(e){this._nodesInstancedGeometry.attributes.translation.setXYZ(this.hoveredNode.__positionIndex,e.x,e.y,0),this._nodesPickingGeometry.attributes.translation.setXYZ(this.hoveredNode.__positionIndex,e.x,e.y,0),this._nodesInstancedGeometry.attributes.translation.needsUpdate=!0,this._nodesPickingGeometry.attributes.translation.needsUpdate=!0},e.prototype.testNode=function(e){if(this._pickingTexture){this._graph._renderer.render(this._pickingNodesScene,this._graph._camera,this._pickingTexture);var t=new Uint8Array(4);this._graph._renderer.readRenderTargetPixels(this._pickingTexture,e.x,this._pickingTexture.height-e.y,1,1,t);var n=t[0]<<16|t[1]<<8|t[2];if(n){var i=this._graph._indexedNodes[this._colorToNodeID[n]];if(this.hoveredNode!==i){null!==this.hoveredNode&&this.setNodeColor(this.hoveredNode.color),this.hoveredNode=this._graph._indexedNodes[this._colorToNodeID[n]],this.setNodeColor(16711680);var r=this._graph._translateCoordinates(this.hoveredNode.x,this.hoveredNode.y);this._graph.onEvent.emit("nodeHover",M({node:this.hoveredNode},r,{scale:this._graph._controls.scale})),this._graph._render()}return!0}return null!==this.hoveredNode&&(this.setNodeColor(this.hoveredNode.color),this._graph.onEvent.emit("nodeUnhover",{node:this.hoveredNode}),this.hoveredNode=null,this._graph._render()),!1}return!1},e.prototype.recalculate=function(){for(var e=new Float32Array(3*this._graph._nodes.length),t=0,n=0,i=this._graph._nodes.length;t<i;t++,n+=3)e[n+0]=this._graph._nodes[t].x,e[n+1]=this._graph._nodes[t].y,e[n+2]=0,this._graph._nodes[t].__positionIndex=t,this._graph._labelsLayer&&this._graph._labelsLayer.setLabelPosition(this._graph._nodes[t].__labelIndex,{x:this._graph._nodes[t].x,y:this._graph._nodes[t].y,z:0},!1);this._nodesInstancedGeometry.attributes.translation.setArray(e),this._nodesInstancedGeometry.attributes.translation.needsUpdate=!0},e.prototype.recalculatePicking=function(){for(var e=new Float32Array(3*this._graph._nodes.length),t=0,n=0,i=this._graph._nodes.length;t<i;t++,n+=3)e[n+0]=this._graph._nodes[t].x,e[n+1]=this._graph._nodes[t].y,e[n+2]=0;this._nodesPickingGeometry.attributes.translation.setArray(e),this._nodesPickingGeometry.attributes.translation.needsUpdate=!0},e.prototype.onScale=function(e){this._nodesMaterial&&(this._nodesMaterial.uniforms.scale.value=e,this._nodesMaterial.needsUpdate=!0,this._nodesPickingMaterial.uniforms.scale.value=e,this._nodesPickingMaterial.needsUpdate=!0)},e.prototype.onResize=function(){this._pickingTexture.setSize(this._graph._container.clientWidth,this._graph._container.clientHeight)},e.prototype.dispose=function(){this._nodeMesh&&this._graph._scene.remove(this._nodeMesh),this._nodesPickingsMesh&&this._pickingNodesScene.remove(this._nodesPickingsMesh),this._nodesInstancedGeometry&&this._nodesInstancedGeometry.dispose(),this._nodesBufferGeometry&&this._nodesBufferGeometry.dispose(),this._nodesPickingGeometry&&this._nodesPickingGeometry.dispose(),this._nodesMaterial&&this._nodesMaterial.dispose(),this._nodesPickingMaterial&&this._nodesPickingMaterial.dispose(),this._imageCanvas&&this._imageCanvas.dispose(),this._imageCanvas.removeEventListener("imageLoaded",this._imageLoaded),this._pickingTexture&&this._pickingTexture.dispose()},e}(),N=function(){return(N=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},P=function(){function e(e){var t=this;this.onEvent=new d,this.nodeScalingFactor=5,this.animationTime=500,this.edges=[],this._options={},this._container=document.body,this._fov=75,this._far=1e4,this._nodes=[],this._center=null,this._dragInProgress=!1,this._dragging=!1,this._plane=new h.Plane,this._raycaster=new h.Raycaster,this._intersection=new h.Vector3,this._offset=new h.Vector3,this._indexedNodes={},this._labelsLayer=null,this.options=e,this.options.container&&(this._container=this.options.container,e.clearContainer&&(this._container.innerHTML="")),this._setupScene(),this._setupCamera(),this._setupRenderer(),this._controls=new e.controls(this._camera,this._container),this._controls.init(),this._controls.addEventListener("scale",this._onScale.bind(this)),this._controls.addEventListener("pan",this._onPan.bind(this)),this._controls.addEventListener("mousemove",this._onMouseMove.bind(this)),this._controls.addEventListener("contextmenu",this._onContextMenu.bind(this)),this._controls.addEventListener("dblclick",this._onDblClick.bind(this)),this._controls.addEventListener("click",this._onClick.bind(this)),this._controls.addEventListener("mousedown",this._onMouseDown.bind(this)),this._controls.addEventListener("mouseup",this._onMouseUp.bind(this)),this._render(),this.options.showLabels&&(this._labelsLayer=new w(this._scene,this.nodeScalingFactor)),this._arrowsLayer=new l(this),this._edgesLayer=new y(this),this._nodesLayer=new C(this),this._resizeHandler=function(){t._renderer.setSize(t._container.clientWidth,t._container.clientHeight),t._camera.aspect=t._container.clientWidth/t._container.clientHeight,t._camera.updateProjectionMatrix(),t._edgesLayer&&t._edgesLayer.onResize(),t._edgesLayer&&t._edgesLayer.onResize(),t._nodesLayer&&t._nodesLayer.onResize(),t._render()},window.addEventListener("resize",this._resizeHandler)}return Object.defineProperty(e.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!0,configurable:!0}),e.prototype.setData=function(e,t){void 0===t&&(t={animate:!1,locate:!1}),this._nodes=e.nodes,this.edges=e.links;var n=JSON.parse(JSON.stringify(this._indexedNodes));if(this._indexingNodes(),e.center&&(this._center=this._indexedNodes[e.center],this._center&&t.locate&&this._controls.setTransform(this._center)),this._labelsLayer&&this._labelsLayer.dispose(),this._arrowsLayer.dispose(),this._edgesLayer.dispose(),this._nodesLayer.dispose(),this._renderer.clear(),this._renderer.renderLists.dispose(),t.animate){for(var i in this._indexedNodes)n[i]?(this._indexedNodes[i].toX=this._indexedNodes[i].x,this._indexedNodes[i].toY=this._indexedNodes[i].y,this._indexedNodes[i].fromX=n[i].x,this._indexedNodes[i].fromY=n[i].y,this._indexedNodes[i].x=n[i].x,this._indexedNodes[i].y=n[i].y):(this._indexedNodes[i].toX=this._indexedNodes[i].x,this._indexedNodes[i].toY=this._indexedNodes[i].y,this._center&&this._indexedNodes[i].id===this._center.id?(this._indexedNodes[i].fromX=this._center.x,this._indexedNodes[i].fromY=this._center.y,this._indexedNodes[i].x=this._center.x,this._indexedNodes[i].y=this._center.y):(this._indexedNodes[i].fromX=this._getRandomFromRange(-this._container.clientWidth,this._container.clientWidth),this._indexedNodes[i].fromY=this._getRandomFromRange(-this._container.clientHeight,this._container.clientHeight),this._indexedNodes[i].x=this._getRandomFromRange(-this._container.clientWidth,this._container.clientWidth),this._indexedNodes[i].y=this._getRandomFromRange(-this._container.clientHeight,this._container.clientHeight)));this._edgesLayer.draw(),this._arrowsLayer.draw(),this._nodesLayer.draw(),this._labelsLayer&&this._labelsLayer.draw(),this._render(),requestAnimationFrame(this._animate.bind(this))}else this._edgesLayer.draw(),this._arrowsLayer.draw(),this._nodesLayer.draw(),this._labelsLayer&&this._labelsLayer.draw(),this._render()},e.prototype.getNodeByID=function(e){var t=this._indexedNodes[e],n=this._translateCoordinates(t.x,t.y);return N({node:t},n,{scale:this._controls.scale})},e.prototype.getScreenshot=function(){var e=new h.WebGLRenderer({premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!0,alpha:!0});return e.setSize(this._container.clientWidth,this._container.clientHeight),e.setPixelRatio(window.devicePixelRatio),e.render(this._scene,this._camera),e.domElement.toDataURL("image/png")},e.prototype.destroy=function(){window.removeEventListener("resize",this._resizeHandler),this._labelsLayer&&this._labelsLayer.dispose(),this._arrowsLayer&&this._arrowsLayer.dispose(),this._edgesLayer&&this._edgesLayer.dispose(),this._nodesLayer&&this._nodesLayer.dispose(),this._disposeRenderer(),this._controls.dispose(),this._nodes=[],this.edges=[],this._indexedNodes={}},e.prototype._onMouseMove=function(e){var t=e.position;if(this._dragging){var n=new h.Vector3;n.x=t.x/this._container.clientWidth*2-1,n.y=-t.y/this._container.clientHeight*2+1;var i={x:this._nodesLayer.hoveredNode.x,y:this._nodesLayer.hoveredNode.y};if(this._dragInProgress)this._raycaster.setFromCamera(n,this._camera),this._raycaster.ray.intersectPlane(this._plane,this._intersection),i=this._intersection.sub(this._offset).clone();else{var r=new h.Vector3;this._camera.getWorldDirection(r),this._plane.setFromNormalAndCoplanarPoint(r,new h.Vector3(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y,0)),this._raycaster.setFromCamera(n,this._camera),this._raycaster.ray.intersectPlane(this._plane,this._intersection),this._offset.copy(this._intersection).sub(new h.Vector3(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y,0)),i=this._intersection.sub(this._offset).clone(),this._dragInProgress=!0}null!==this._nodesLayer.hoveredNode&&(this._nodesLayer.setNodePosition(i),this._labelsLayer&&this._nodesLayer.hoveredNode.__labelIndex&&this._labelsLayer.setLabelPosition(this._nodesLayer.hoveredNode.__labelIndex,{x:i.x,y:i.y,z:0})),this._nodesLayer.hoveredNode.x=i.x,this._nodesLayer.hoveredNode.y=i.y;var s=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeMoving",N({node:this._nodesLayer.hoveredNode},s,{scale:this._controls.scale})),this._edgesLayer.recalculate(),this._edgesLayer.recalculatePicking(),this._arrowsLayer.recalculate()}else this._nodesLayer.testNode(t)||this._edgesLayer.testEdge(t);this._render()},e.prototype._onMouseUp=function(){this._controls.enabled=!0,this._dragging=!1,this._dragInProgress=!1},e.prototype._onMouseDown=function(e){var t=e.event;null!==this._nodesLayer.hoveredNode&&1===t.buttons&&(this._controls.enabled=!1,this._dragging=!0)},e.prototype._onClick=function(){if(this._nodesLayer.hoveredNode){var e=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeClick",N({node:this._nodesLayer.hoveredNode},e,{scale:this._controls.scale}))}this._nodesLayer.hoveredNode||this._edgesLayer.hoveredEdge||this.onEvent.emit("workspaceClick")},e.prototype._onDblClick=function(){if(null!==this._nodesLayer.hoveredNode){var e=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeDblClick",N({node:this._nodesLayer.hoveredNode},e,{scale:this._controls.scale}))}},e.prototype._onContextMenu=function(e){if(this._nodesLayer.hoveredNode){var t=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeContextMenu",N({node:this._nodesLayer.hoveredNode},t,{scale:this._controls.scale}))}else this._edgesLayer.hoveredEdge&&this.onEvent.emit("edgeContextMenu",{edge:this._edgesLayer.hoveredEdge,coordinates:e,scale:this._controls.scale})},e.prototype._onPan=function(){if(this._render(),this._nodesLayer.hoveredNode){var e=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeScaling",N({node:this._nodesLayer.hoveredNode},e,{scale:this._controls.scale}))}else this.onEvent.emit("workspaceViewChanged",{scale:this._controls.scale})},e.prototype._onScale=function(e){if(this._nodesLayer&&this._nodesLayer.onScale(e.scale),this._edgesLayer&&this._edgesLayer.onScale(e.scale),this._render(),this._nodesLayer.hoveredNode){var t=this._translateCoordinates(this._nodesLayer.hoveredNode.x,this._nodesLayer.hoveredNode.y);this.onEvent.emit("nodeScaling",N({node:this._nodesLayer.hoveredNode},t,{scale:this._controls.scale}))}else this.onEvent.emit("workspaceViewChanged",{scale:this._controls.scale})},e.prototype._disposeRenderer=function(){this._renderer&&(this._renderer.clear(),this._renderer.renderLists.dispose(),this._container.removeChild(this._renderer.domElement),this._renderer.dispose())},e.prototype._translateCoordinates=function(e,t){var n=new h.Vector3(e,t,0),i=.5*this._renderer.context.canvas.width,r=.5*this._renderer.context.canvas.height;return n.project(this._camera),n.x=n.x*i+i,n.y=-n.y*r+r,{x:n.x,y:n.y}},e.prototype._setupScene=function(){this._scene=new h.Scene,this._scene.background=new h.Color(this.options.backgroundColor||"white")},e.prototype._setupCamera=function(){this._camera=new h.PerspectiveCamera(this._fov,this._container.clientWidth/this._container.clientHeight,.1,this._far),this._camera.lookAt(0,0,0)},e.prototype._setupRenderer=function(){this._renderer=new h.WebGLRenderer({alpha:!0,antialias:!0}),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(this._container.clientWidth,this._container.clientHeight),this._container.appendChild(this._renderer.domElement)},e.prototype._render=function(){console.log("Render draw calls: ",this._renderer.info),this._renderer.render(this._scene,this._camera)},e.prototype._indexingNodes=function(){var e=this;this._indexedNodes={},this._nodes.forEach(function(t){e._indexedNodes[t.id]&&console.error("Node with id "+t.id+" already exists"),e._indexedNodes[t.id]=t})},e.prototype._moveNodes=function(e){void 0===e&&(e=!1),this._nodesLayer&&this._nodesLayer.recalculate(),this._labelsLayer&&this._labelsLayer.recalculate(),this._edgesLayer&&this._edgesLayer.recalculate(),this._arrowsLayer&&this._arrowsLayer.recalculate(),e&&(this._nodesLayer&&this._nodesLayer.recalculatePicking(),this._edgesLayer&&this._edgesLayer.recalculatePicking())},e.prototype._getRandomFromRange=function(e,t){return Math.floor(Math.random()*(t-e))+e},e.prototype._interpolate=function(e){var t=e;return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},e.prototype._animate=function(){var e=this,t=Date.now();this._arrowsLayer.hide(),this._labelsLayer&&this._labelsLayer.hide(),this._nodesLayer.setSilent(!0);var n=function(){var i=(Date.now()-t)/e.animationTime;if(i>=1){for(var r in e._indexedNodes)e._indexedNodes[r]&&(e._indexedNodes[r].x=e._indexedNodes[r].toX,e._indexedNodes[r].y=e._indexedNodes[r].toY);e._moveNodes(!0),e._arrowsLayer.show(),e._labelsLayer&&e._labelsLayer.show(),e._nodesLayer.setSilent(!1),e._render()}else{for(var r in i=e._interpolate(i),e._indexedNodes)e._indexedNodes[r]&&(e._indexedNodes[r].x=e._indexedNodes[r].toX*i+e._indexedNodes[r].fromX*(1-i),e._indexedNodes[r].y=e._indexedNodes[r].toY*i+e._indexedNodes[r].fromY*(1-i));e._moveNodes(),e._render(),requestAnimationFrame(n)}};n()},e}();n.d(t,"PretyGraph",function(){return P})}])});